import { Slider, ComboBox, ListView } from "std-widgets.slint";

export component AppWindow inherits Window {
    // Properties set from Rust
    in property <[string]> categories;
    in property <[[string]]> symbol-rows;
    in property <string> status-text: "Ready";

    // FIX: changed from `out` to `in-out` so Rust can also set the selected index
    // programmatically (e.g. for search or deep-linking features in the future).
    in-out property <int> selected-index: 0;
    in-out property <length> symbol-size: 60px;

    // Signals for Rust
    callback category-changed(int);
    callback symbol-clicked(string);

    title: "SMuFL Explorer";
    min-width: 900px;
    min-height: 700px;
    background: #1a1a1a;

    // NOTE: "Finale Maestro" (or any SMuFL-compliant font) must be installed on
    // the system for glyphs to render correctly. If the font is missing, all
    // symbols will appear as tofu boxes (â–¡).
    // Consider bundling the font with the application and using a @font-face rule.
    default-font-family: "Finale Maestro";

    VerticalLayout {
        padding: 25px;
        spacing: 15px;

        // --- HEADER ---
        HorizontalLayout {
            height: 60px;

            VerticalLayout {
                alignment: center;
                Text {
                    text: "SMuFL Explorer";
                    font-size: 22px;
                    color: white;
                    font-weight: 800;
                }
                Text {
                    text: status-text;
                    color: #4CAF50;
                    font-size: 13px;
                    font-weight: 500;
                }
            }

            // FIX: explicit horizontal-stretch so this rectangle actually acts
            // as a flexible spacer and pushes the ComboBox to the right.
            Rectangle { horizontal-stretch: 1; }

            // Category selector
            VerticalLayout {
                alignment: center;
                spacing: 4px;

                Text {
                    text: "CATEGORY";
                    color: #777;
                    font-size: 10px;
                    font-weight: 800;
                    horizontal-alignment: right;
                }

                Rectangle {
                    width: 380px;
                    height: 36px;
                    background: #2a2a2a;
                    border-radius: 4px;

                    ComboBox {
                        width: 100%;
                        height: 100%;
                        model: root.categories;
                        current-index <=> root.selected-index;
                        selected => { root.category-changed(self.current-index); }
                    }
                }
            }
        }

        // --- SYMBOL GRID (virtualised) ---
        // FIX: vertical-stretch: 1 ensures this Rectangle expands to fill all
        // remaining vertical space, preventing the ListView from collapsing.
        Rectangle {
            vertical-stretch: 1;
            background: #212121;
            border-radius: 12px;
            border-width: 1px;
            border-color: #333;
            clip: true;

            ListView {
                for row in root.symbol-rows: HorizontalLayout {
                    padding: 10px;
                    spacing: 12px;
                    alignment: start;

                    for sym in row: Rectangle {
                        width: root.symbol-size;
                        height: root.symbol-size;
                        background: touch.has-hover ? #3d3d3d : #2d2d2d;
                        border-radius: 6px;
                        border-width: 1px;
                        border-color: touch.has-hover ? #555 : transparent;

                        animate background { duration: 150ms; }

                        Text {
                            text: sym;
                            // FIX: clamp the derived font-size to prevent it from
                            // becoming too small or excessively large.
                            font-size: max(12px, min(root.symbol-size * 0.65, 100px));
                            // FIX: replaced #00ff00 with a softer green that is
                            // consistent with the #4CAF50 already used in the header.
                            color: touch.has-hover ? #4CAF50 : #eee;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        // Tooltip: show the Unicode codepoint on hover.
                        // Rendered as a small overlay label at the bottom of the cell.
                        if touch.has-hover: Rectangle {
                            y: parent.height - 18px;
                            height: 18px;
                            width: parent.width;
                            background: #00000088;
                            border-radius: 4px;

                            Text {
                                width: 100%;
                                height: 100%;
                                // The codepoint label is set by Rust via the glyph
                                // string itself; here we show a static placeholder.
                                // For a full codepoint display, pass an extra model
                                // with the hex values alongside the glyphs.
                                text: sym;
                                font-size: 9px;
                                color: #aaa;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        touch := TouchArea {
                            clicked => { root.symbol-clicked(sym); }
                        }
                    }
                }
            }
        }

        // --- FOOTER ---
        HorizontalLayout {
            height: 40px;
            spacing: 20px;
            alignment: center;

            Text {
                text: "Icon size:";
                vertical-alignment: center;
                color: #666;
                font-size: 12px;
            }

            Slider {
                width: 250px;
                minimum: 35;
                maximum: 150;
                value: root.symbol-size / 1px;
                changed(v) => { root.symbol-size = v * 1px; }
            }

            Text {
                text: round(root.symbol-size / 1px) + "px";
                width: 45px;
                vertical-alignment: center;
                color: #aaa;
                font-size: 13px;
                font-weight: 600;
            }
        }
    }
}

